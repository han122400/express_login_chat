<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로그인 완료</title>
  </head>
  <body style="text-align: center">
    <h1 id="welcome">로그인 성공!!</h1>
    <br />
    <button type="button" id="logout">로그아웃</button>
    <button type="button" id="del">회원탈퇴</button>
    <hr />
    <!-- 채팅창 UI -->
    <section
      id="chat-container"
      style="max-width: 600px; margin: 0 auto; text-align: left"
    >
      <h2>실시간 채팅</h2>
      <div
        id="chat-box"
        style="
          border: 3px solid #000000;
          border-radius: 10px;
          height: 400px;
          padding: 10px;
          overflow-y: scroll;
          background-color: #95f8ffb6;
        "
      ></div>
      <div style="margin-top: 10px; display: flex; gap: 10px">
        <input
          type="text"
          id="chat-input"
          placeholder="메시지를 입력하세요"
          style="flex: 1; padding: 8px"
        />
        <button id="send-btn" style="padding: 8px 16px">전송</button>
      </div>
    </section>

    <script>
      // id 정보 가져오기
      fetch('/getUserId')
        .then((res) => res.json())
        .then((data) => {
          if (data.userId) {
            document.getElementById(
              'welcome'
            ).innerText = `로그인 계정: ${data.userId}`
          } else {
            // 세션이 없으면 로그인 페이지로 이동
            alert('로그인이 필요합니다.')
            window.location.href = '/main'
          }
        })
      // 로그아웃 버튼
      document.getElementById('logout').addEventListener('click', function () {
        alert('로그아웃 완료')
        window.location.href = '/logout'
      })

      // 회원탈퇴 버튼
      document
        .getElementById('del')
        .addEventListener('click', async function () {
          // /deleteUser 엔드포인트로 POST 요청
          const res = await fetch('/deleteUser', { method: 'POST' })
          const data = await res.json()
          if (data.success) {
            alert('회원탈퇴가 완료되었습니다')
            window.location.href = '/main' // 메인화면으로 이동
          } else {
            alert(data.message || '회원탈퇴 실패')
          }
        })

      // 채팅 기능------------------------------------------------------------------
      let myUserId = null

      // 내 user_id 가져오기
      fetch('/getUserId')
        .then((res) => res.json())
        .then((data) => {
          if (data.userId) {
            myUserId = data.userId
            document.getElementById(
              'welcome'
            ).innerText = `로그인 계정: ${data.userId}`
            loadChats() // 최초 채팅 불러오기
            setInterval(loadChats, 1000) // 1초마다 채팅 갱신
          } else {
            alert('로그인이 필요합니다.')
            window.location.href = '/main'
          }
        })

      // 채팅 전송
      document.getElementById('send-btn').addEventListener('click', sendChat)
      document
        .getElementById('chat-input')
        .addEventListener('keydown', function (e) {
          if (e.key === 'Enter') sendChat()
        })

      function sendChat() {
        const text = document.getElementById('chat-input').value.trim()
        if (!text) return
        fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: myUserId, text }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              document.getElementById('chat-input').value = ''
              loadChats()
            } else {
              alert(data.message || '채팅 전송 실패')
            }
          })
      }

      // 채팅 불러오기
      function loadChats() {
        const chatBox = document.getElementById('chat-box')
        // 스크롤이 맨 아래에 있는지 확인
        const isAtBottom =
          chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 5
        fetch('/chat')
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              chatBox.innerHTML = ''
              data.chats.forEach((chat) => {
                const chatDiv = document.createElement('div')
                chatDiv.style.marginBottom = '18px'
                chatDiv.innerHTML = `
                  <div style="font-weight:bold;color:#0077cc">${
                    chat.user_id
                  }</div>
                  <div style="margin:2px 0 2px 10px;">${chat.text}</div>
                  <div style="font-size:12px;color:#888;margin-left:10px;">${formatTime(
                    chat.time
                  )}</div>
                `
                chatBox.appendChild(chatDiv)
              })
              // 스크롤이 맨 아래였을 때만 자동 스크롤
              if (isAtBottom) {
                chatBox.scrollTop = chatBox.scrollHeight
              }
            }
          })
      }

      // 날짜/시간 포맷
      function formatTime(timeStr) {
        const d = new Date(timeStr)
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
          2,
          '0'
        )}-${String(d.getDate()).padStart(2, '0')} ${String(
          d.getHours()
        ).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`
      }
    </script>
  </body>
</html>
